---
title: "LOSO-CV Results"
output: 
  html_document: 
    toc: yes
    fig_width: 22
    fig_height: 13
    fig.retina: 2
    device: ragg::agg_png
    self_contained: no
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(acceleep)
library(ggplot2)
library(dplyr)
library(tidyr)
library(kableExtra)
library(hrbrthemes)
library(tadaathemes)

theme_set(theme_ipsum_ss())

# Iterate over all model output folders, read in latest CV runs, bind together
cv_results <- purrr::map_df(
  here::here("output/cross-validation-full", c("LM", "LM0", "RF", "DNN", "CNN", "RNN")),
  ~read_cv_results(.x, latest_only = FALSE)
) %>%
  mutate(
    model_kind = ifelse(model_kind == "RNN", glue::glue("{model_kind} ({res}Hz)"), model_kind),
    model_kind = ifelse(model_kind %in% c("RNN (100Hz)", "RNN (20Hz)"), "RNN (100Hz/20Hz)", model_kind)
  )
```


## Boxplot by Accelerometer

```{r boxplot-by-accelerometer}
cv_results %>%
  tidyr::unnest(data) %>%
  ggplot(aes(x = reorder(model_kind, rmse), y = rmse)) +
  facet_grid(cols = vars(accel), rows = vars(outcome_unit), scales = "free_y") +
  geom_point(size = 1, alpha = .2, position = position_jitter(width = .15, seed = 23)) +
  geom_boxplot(alpha = .5, outlier.alpha = 0) +
  stat_summary(geom = "point", fun = mean, fill = "white", shape = 21, color = "black", size = 2) +
  labs(
    title = "Leave-One-Subject-Out Cross Validation",
    subtitle = "Across all subjects in the sample dataset",
    x = "Model Type", y = "Per-Subject RMSE (Quartiles + Mean)"
  ) +
  theme_ipsum_ss(grid = "Y")


# ggsave(filename = here::here("LOSO-CV-boxplot-20200907.pdf"), device = cairo_pdf, scale = 2, width = 10, height = 5)
```

```{r boxplot-by-unit-accel}
cv_results %>%
  tidyr::unnest(data) %>%
  ggplot(aes(y = forcats::fct_rev(accel), x = rmse)) +
  facet_grid(rows = vars(model_kind), cols = vars(outcome_unit), scales = "free") +
  geom_point(size = 1, alpha = .2, position = position_jitter(width = .01, seed = 23)) +
  geom_boxplot(alpha = .5, outlier.alpha = 0) +
  stat_summary(geom = "point", fun = mean, fill = "white", shape = 21, color = "black", size = 2) +
  labs(
    title = "Leave-One-Subject-Out Cross Validation",
    subtitle = "Across all subjects in the sample dataset",
    y = "Accelerometer", x = "Per-Subject RMSE (Quartiles + Mean)"
  ) +
  theme_ipsum_ss(grid = "X")
```

### Horizontal box plot grouped by model

```{r boxplot-by-unit}
cv_results %>%
  tidyr::unnest(data) %>%
    mutate(
    accel = stringr::str_replace(accel, "\\s\\(", "\n\\(")
  ) %>%
  ggplot(aes(y = reorder(model_kind, -rmse), x = rmse)) +
  facet_grid(rows = vars(accel), cols = vars(outcome_unit), scales = "free_x") +
  geom_point(size = 1, alpha = .2, position = position_jitter(width = .05, seed = 23)) +
  geom_boxplot(alpha = .5, outlier.alpha = 0) +
  stat_summary(geom = "point", fun = mean, fill = "white", shape = 21, color = "black", size = 2) +
  labs(
    title = "Leave-One-Subject-Out Cross Validation",
    subtitle = "Across all subjects in the sample dataset",
    y = "Model Type", x = "Per-Subject RMSE (Quartiles + Mean)"
  ) +
  theme_ipsum_ss(
    grid = "X",
    strip_text_size = 9
  )
```

Subset to only primary models of interest:

```{r boxplot-by-unit-mainmodels}
cv_results %>%
  filter(model_kind %in% c("RF", "CNN")) %>%
  tidyr::unnest(data) %>%
  mutate(
    accel = stringr::str_replace(accel, "\\s\\(", "\n\\(")
  ) %>%
  ggplot(aes(y = reorder(model_kind, -rmse), x = rmse)) +
  facet_grid(rows = vars(accel), cols = vars(outcome_unit), scales = "free_x") +
  geom_point(size = 1, alpha = .2, position = position_jitter(width = .05, seed = 23)) +
  geom_boxplot(alpha = .5, outlier.alpha = 0) +
  stat_summary(geom = "point", fun = mean, fill = "white", shape = 21, color = "black", size = 2) +
  labs(
    title = "Leave-One-Subject-Out Cross Validation",
    subtitle = "Across all subjects in the sample dataset",
    y = "Model Type", x = "Per-Subject RMSE (Quartiles + Mean)"
  ) +
  theme_ipsum_ss(
    grid = "X",
    strip_text_size = 9
  )
```

### Mean + SD

```{r meansd-by-unit}
cv_results %>%
  tidyr::unnest(data) %>%
  mutate(
    accel = stringr::str_replace(accel, "\\s\\(", "\n\\(")
  ) %>%
  group_by(model_kind, accel, outcome_unit) %>%
  summarize(
    y = mean(rmse),
    ymin = y - sd(rmse),
    ymax = y + sd(rmse),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = reorder(model_kind, -y), y = y)) +
  coord_flip() +
  facet_grid(rows = vars(accel), cols = vars(outcome_unit), scales = "free_x") +
  geom_errorbar(aes(ymin = ymin, ymax = ymax)) +
  geom_point(fill = "white", shape = 21, color = "black", size = 2) +
  labs(
    title = "Leave-One-Subject-Out Cross Validation",
    subtitle = "Across all subjects in the sample dataset",
    y = "Model Type", x = "Per-Subject RMSE (Mean +- SD)"
  ) +
  theme_ipsum_ss(
    grid = "X",
    strip_text_size = 9
  )
```

```{r meansd-by-unit-mainmodels}
cv_results %>%
  filter(model_kind %in% c("RF", "CNN")) %>%
  tidyr::unnest(data) %>%
  mutate(
    accel = stringr::str_replace(accel, "\\s\\(", "\n\\(")
  ) %>%
  group_by(model_kind, accel, outcome_unit) %>%
  summarize(
    y = mean(rmse),
    ymin = y - sd(rmse),
    ymax = y + sd(rmse),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = reorder(model_kind, -y), y = y)) +
  coord_flip() +
  facet_grid(rows = vars(accel), cols = vars(outcome_unit), scales = "free_x") +
  geom_errorbar(aes(ymin = ymin, ymax = ymax)) +
  geom_point(fill = "white", shape = 21, color = "black", size = 2) +
  labs(
    title = "Leave-One-Subject-Out Cross Validation",
    subtitle = "Across all subjects in the sample dataset",
    y = "Model Type", x = "Per-Subject RMSE (Mean +- SD)"
  ) +
  theme_ipsum_ss(
    grid = "X",
    strip_text_size = 9
  )

cv_results %>%
  filter(model_kind %in% c("RF", "CNN", "LM", "DNN")) %>%
  tidyr::unnest(data) %>%
  mutate(
    accel = stringr::str_replace(accel, "\\s\\(", "\n\\(")
  ) %>%
  group_by(model_kind, accel, outcome_unit) %>%
  summarize(
    y = mean(rmse),
    ymin = y - sd(rmse),
    ymax = y + sd(rmse),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = reorder(model_kind, y), y = y)) +
  facet_grid(cols = vars(accel), rows = vars(outcome_unit), scales = "free") +
  geom_errorbar(aes(ymin = ymin, ymax = ymax)) +
  geom_point(fill = "white", shape = 21, color = "black", size = 2) +
  labs(
    title = "Leave-One-Subject-Out Cross Validation",
    subtitle = "Across all subjects in the sample dataset",
    x = "Model Type", y = "Per-Subject RMSE (Mean +- SD)"
  ) +
  theme_ipsum_ss(
    grid = "Yy",
    strip_text_size = 9
  )
```

### Histograms

```{r hist-by-accel}
cv_results %>%
  tidyr::unnest(data) %>%
  ggplot(aes(x = rmse, fill = accel, color = accel)) +
  facet_grid(cols = vars(outcome_unit), rows = vars(model_kind), scales = "free") +
  geom_density(aes(y = stat(scaled)), alpha = .1) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  theme_ipsum_ss()
```

```{r hist-by-model}
cv_results %>%
  tidyr::unnest(data) %>%
  ggplot(aes(x = rmse, fill = model_kind, color = model_kind)) +
  facet_grid(cols = vars(outcome_unit), rows = vars(accel), scales = "free") +
  geom_density(aes(y = stat(scaled)), alpha = .1) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  theme_ipsum_ss()
```

```{r histby-model-mainmodels}
cv_results %>%
  filter(model_kind %in% c("RF", "CNN")) %>%
  tidyr::unnest(data) %>%
    mutate(
    accel = stringr::str_replace(accel, "\\s\\(", "\n\\(")
  ) %>%
  ggplot(aes(x = rmse, fill = model_kind, color = model_kind)) +
  facet_grid(rows = vars(accel), cols = vars(outcome_unit), scales = "free_x") +
  geom_density(aes(y = stat(scaled)), alpha = .2) +
  geom_histogram(aes(y = stat(ndensity)), bins = 20, alpha = .2, position = position_dodge2()) +
  scale_color_brewer(palette = "Dark2", aesthetics = c("color", "fill")) +
  labs(
    title = "Leave-One-Subject-Out Cross Validation",
    subtitle = "Across all subjects in the sample dataset",
    y = "Model Type", x = "Per-Subject RMSE (Quartiles + Mean)"
  ) +
  theme_ipsum_ss(
    grid = "Y",
    strip_text_size = 9
  )
```


## Tables

```{r table-by-accel}
cv_results %>%
  transmute(
    model_kind = model_kind,
    accel = accel,
    outcome_unit = outcome_unit,
    measure = glue::glue("{round(mean_rmse, 2)} ({round(sd_rmse, 2)})") %>% as.character()
  ) %>%
  tidyr::pivot_wider(names_from = accel, values_from = measure) %>%
  rename(Model = model_kind, Outcome = outcome_unit) %>%
  kable(caption = glue::glue("LOSO-CV results, Mean RMSE (SD)")) %>%
  kable_styling() %>%
  collapse_rows(columns = 1)
```

```{r table-by-model}
cv_results %>%
  mutate(
    measure = glue::glue("{round(mean_rmse, 2)} ({round(sd_rmse, 2)})") %>% as.character()
  ) %>%
  group_by(accel, outcome_unit) %>%
  mutate(
    # min_rmse = min(mean_rmse),
    is_min_mean_rmse = mean_rmse == min(mean_rmse)
  ) %>%
  ungroup() %>%
  select(
    model_kind,
    accel,
    outcome_unit,
    measure,
    is_min_mean_rmse
  ) %>%
  mutate(measure = cell_spec(measure, bold = is_min_mean_rmse)) %>%
  select(-is_min_mean_rmse) %>%
  pivot_wider(id_cols = c(model_kind, accel, outcome_unit), names_from = model_kind, values_from = measure) %>%
  rename(Accelerometer = accel, Outcome = outcome_unit) %>%
  kable(
    caption = glue::glue("LOSO-CV results: Mean RMSE (SD)"), escape = FALSE
  ) %>%
  kable_styling() %>%
  collapse_rows(columns = 1) %>%
  footnote(general_title = "Bold:", general = "Minimal RMSE per Row (Accelerometer and Outcome)")
```

Preferred table for final text:

```{r table-by-model-redux}
cv_results %>%
  mutate(
    measure = glue::glue("{round(mean_rmse, 2)} ({round(sd_rmse, 2)})") %>% as.character()
  ) %>%
  group_by(accel, outcome_unit) %>%
  mutate(
    # min_rmse = min(mean_rmse),
    is_min_mean_rmse = mean_rmse == min(mean_rmse)
  ) %>%
  ungroup() %>%
  select(
    model_kind,
    accel,
    outcome_unit,
    measure,
    is_min_mean_rmse
  ) %>%
  mutate(measure = cell_spec(measure, bold = is_min_mean_rmse)) %>%
  select(-is_min_mean_rmse) %>%
  pivot_wider(id_cols = c(model_kind, accel, outcome_unit), names_from = model_kind, values_from = measure) %>%
  rename(Accelerometer = accel, Outcome = outcome_unit) %>%
  select(Outcome, Accelerometer, everything()) %>%
  arrange(Outcome) %>%
  select(-Outcome) %>%
  kable(
    caption = glue::glue("LOSO-CV results: Mean RMSE (SD)"), escape = FALSE
  ) %>%
  kable_styling() %>%
  pack_rows("kJ/min (AEE)", 1, 6) %>%
  pack_rows("MET", 7, 12) %>%
  pack_rows("J/min/kg (REE)", 13, 18) %>%
  footnote(general_title = "Bold:", general = "Minimal RMSE per Row (Accelerometer and Outcome)")
```

# Model Runtime

Model runtime summaries (seconds)

```{r runtime}
cv_results %>%
  unnest(data) %>%
  filter(!is.na(model_took)) %>%
  group_by(model_kind) %>%
  summarize(
    mean_took = mean(model_took, na.rm = TRUE),
    sd_took =  sd(model_took, na.rm = TRUE),
    range_took = paste0(range(model_took), collapse = " â€“ "),
    .groups = "drop"
  ) %>%
  kable(digits = 2, caption = "Model runtimes") %>%
  kable_styling()

```

