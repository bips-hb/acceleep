---
title: "LOSO-CV Results"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(acceleep)
library(ggplot2)
library(dplyr)
library(tidyr)
library(kableExtra)

theme_set(hrbrthemes::theme_ipsum())
```

```{r read-data}
# Iterate over all model output folders, read in latest CV runs, bind together
cv_results <- purrr::map_df(
  here::here("output/cross-validation", c("LM", "RF", "DNN", "CNN", "RNN")),
  read_cv_results
)
```

## Boxplot

```{r boxplot}
cv_results %>%
  tidyr::unnest(data) %>%
  ggplot(aes(x = reorder(model_kind, rmse), y = rmse)) +
  facet_grid(cols = vars(accel), rows = vars(outcome_unit), scales = "free_y") +
  geom_point(size = 1, alpha = .2, position = position_jitter(width = .15, seed = 23)) +
  geom_boxplot(alpha = .5, outlier.alpha = 0) +
  stat_summary(geom = "point", fun = mean, fill = "red", shape = 21, color = "black", size = 2) +
  labs(
    title = "Leave-One-Subject-Out Cross Validation",
    subtitle = "Across all subjects in the respective training set (2/3 of complete data)",
    x = "Model Type", y = "Per-Subject RMSE (+ Mean)"
  ) +
  hrbrthemes::theme_ipsum_pub(grid = "Y")
```


## Table

```{r table}
cv_results %>%
  transmute(
    model_kind = model_kind,
    accel = accel,
    outcome_unit = outcome_unit,
    measure = glue::glue("{round(mean_rmse, 2)} ({round(sd_rmse, 2)})") %>% as.character()
  ) %>%
  tidyr::pivot_wider(names_from = accel, values_from = measure) %>%
  #slice(c(3, 1, 2)) %>%
  kable(caption = glue::glue("LOSO-CV results, Mean RMSE (SD)")) %>%
  kable_styling() %>%
  collapse_rows(columns = 1)

```

## Per-Model Predictions

```{r pred-cnn}
vec_model_kind <- unique(cv_results$model_kind)
vec_accel <- unique(cv_results$accel)
vec_outcome_unit <- unique(cv_results$outcome_unit)

cv_results %>%
  filter(model_kind == "CNN", accel == first(accel), outcome_unit == first(outcome_unit)) %>%
  unnest(data) %>%
  unnest(predicted_obs) %>%
  pivot_longer(cols = c(outcome, predicted)) %>%
  ggplot(aes(x = interval, y = value, color = name)) +
  facet_wrap(~left_out, scales = "free_x") +
  geom_path() +
  scale_color_brewer(palette = "Dark2") +
  labs(
    title = glue::glue("Per-Subject Predictions for"),
    subtitle = "Predictions based on model for which respective subject is not in training data",
    x = "Interval", y = "Outcome Unit", color = ""
  ) +
  theme(legend.position = "top")
```

