---
title: "LOSO-CV Results"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(acceleep)
library(ggplot2)
library(dplyr)
library(kableExtra)

theme_set(hrbrthemes::theme_ipsum())
```

```{r read-data}
read_cv_results <- function(path) {
  # browser()
  # get latest run
  path <- rev(sort(fs::dir_ls(path)))[[1]]
  
  purrr::map_df(fs::dir_ls(path, glob = "*.rds"), ~{
    tibble::tibble(
      file = .x,
      data = list(readRDS(.x) %>% filter(!is.na(left_out)))
    )
  }) %>%
    mutate(
      file = fs::path_file(file) %>% fs::path_ext_remove(),
      mean_rmse = purrr::map_dbl(data, ~mean(.x$rmse)),
      median_rmse = purrr::map_dbl(data, ~median(.x$rmse)),
      sd_rmse = purrr::map_dbl(data, ~sd(.x$rmse))
    ) %>%
    tidyr::separate(
      col = file,
      into = c("folds", "method", "model_kind", "model", "placement", "outcome", "res", "timestamp"),
      sep = "-"
    ) %>%
    mutate(
      model = label_accel_models(model),
      placement = purrr::map_chr(placement, label_placement),
      accel = glue::glue("{model} ({placement})")
    )
}

# Iterate over all model output folders, read in latest CV runs, bind together
cv_results <- purrr::map_df(
  here::here("output/cross-validation", c("LM", "DNN", "CNN", "RNN")),
  read_cv_results
)
```

## Boxplot

```{r boxplot}
cv_results %>%
  tidyr::unnest(data) %>%
  ggplot(aes(x = model_kind, y = rmse)) +
  facet_grid(cols = vars(accel), rows = vars(outcome), scales = "free_y") +
  geom_boxplot() +
  stat_summary(geom = "point", fun = mean, color = "red")
```


## Table

```{r table}
cv_results %>%
  transmute(
    model_kind = model_kind,
    accel = accel,
    outcome = outcome,
    measure = glue::glue("{round(mean_rmse, 2)} ({round(sd_rmse, 2)})") %>% as.character()
  ) %>%
  tidyr::pivot_wider(names_from = accel, values_from = measure) %>%
  #slice(c(3, 1, 2)) %>%
  kable(caption = glue::glue("LOSO-CV results, Mean RMSE (SD)")) %>%
  kable_styling()

```

