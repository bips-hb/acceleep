---
title: "LOSO-CV Results"
output: 
  html_document: 
    toc: yes
    fig_width: 20
    fig.height: 10
    fig.retina: 2
    device: ragg::agg_png
    self_contained: no
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(acceleep)
library(ggplot2)
library(dplyr)
library(tidyr)
library(kableExtra)

theme_set(hrbrthemes::theme_ipsum_ps())
```

```{r read-data}
# Iterate over all model output folders, read in latest CV runs, bind together
cv_results <- purrr::map_df(
  here::here("output/cross-validation", c("LM", "RF", "DNN", "CNN", "RNN")),
  read_cv_results
)
```

## Boxplot by Accelerometer

```{r boxplot-by-accelerometer}
cv_results %>%
  tidyr::unnest(data) %>%
  ggplot(aes(x = reorder(model_kind, rmse), y = rmse)) +
  facet_grid(cols = vars(accel), rows = vars(outcome_unit), scales = "free_y") +
  geom_point(size = 1, alpha = .2, position = position_jitter(width = .15, seed = 23)) +
  geom_boxplot(alpha = .5, outlier.alpha = 0) +
  stat_summary(geom = "point", fun = mean, fill = "white", shape = 21, color = "black", size = 2) +
  labs(
    title = "Leave-One-Subject-Out Cross Validation",
    subtitle = "Across all subjects in the respective training set (2/3 of complete data)",
    x = "Model Type", y = "Per-Subject RMSE (Quartiles + Mean)"
  ) +
  hrbrthemes::theme_ipsum_ps(grid = "Y")


# ggsave(filename = here::here("LOSO-CV-boxplot-20200907.pdf"), device = cairo_pdf, scale = 2, width = 10, height = 5)
```

```{r boxplot-by-unit}
cv_results %>%
  tidyr::unnest(data) %>%
  ggplot(aes(y = reorder(model_kind, -rmse), x = rmse)) +
  facet_grid(rows = vars(accel), cols = vars(outcome_unit), scales = "free_x") +
  geom_point(size = 1, alpha = .2, position = position_jitter(width = .05, seed = 23)) +
  geom_boxplot(alpha = .5, outlier.alpha = 0) +
  stat_summary(geom = "point", fun = mean, fill = "white", shape = 21, color = "black", size = 2) +
  labs(
    title = "Leave-One-Subject-Out Cross Validation",
    subtitle = "Across all subjects in the respective training set (2/3 of complete data)",
    y = "Model Type", x = "Per-Subject RMSE (Quartiles + Mean)"
  ) +
  hrbrthemes::theme_ipsum_ps(grid = "Y")
```

```{r meanci-by-unit}
cv_results %>%
  tidyr::unnest(data) %>%
  ggplot(aes(y = reorder(model_kind, -rmse), x = rmse)) +
  facet_grid(rows = vars(accel), cols = vars(outcome_unit), scales = "free_x") +
  stat_summary(geom = "errorbar", fun.data = "mean_cl_boot")  +
  stat_summary(geom = "point", fun = mean, fill = "white", shape = 21, color = "black", size = 2) +
  labs(
    title = "Leave-One-Subject-Out Cross Validation",
    subtitle = "Across all subjects in the respective training set (2/3 of complete data)",
    y = "Model Type", x = "Per-Subject RMSE (Mean + Bootstrap-CI)"
  ) +
  hrbrthemes::theme_ipsum_ps(grid = "Y")
```


## Tables

```{r table-by-accel}
cv_results %>%
  transmute(
    model_kind = model_kind,
    accel = accel,
    outcome_unit = outcome_unit,
    measure = glue::glue("{round(mean_rmse, 2)} ({round(sd_rmse, 2)})") %>% as.character()
  ) %>%
  tidyr::pivot_wider(names_from = accel, values_from = measure) %>%
  rename(Model = model_kind, Outcome = outcome_unit) %>%
  kable(caption = glue::glue("LOSO-CV results, Mean RMSE (SD)")) %>%
  kable_styling() %>%
  collapse_rows(columns = 1)
```

```{r table-by-model}
cv_results %>%
  mutate(
    measure = glue::glue("{round(mean_rmse, 2)} ({round(sd_rmse, 2)})") %>% as.character()
  ) %>%
  group_by(accel, outcome_unit) %>%
  mutate(
    # min_rmse = min(mean_rmse),
    is_min_mean_rmse = mean_rmse == min(mean_rmse)
  ) %>%
  ungroup() %>%
  select(
    model_kind,
    accel,
    outcome_unit,
    measure,
    is_min_mean_rmse
  ) %>%
  mutate(measure = cell_spec(measure, bold = is_min_mean_rmse)) %>%
  select(-is_min_mean_rmse) %>%
  pivot_wider(id_cols = c(model_kind, accel, outcome_unit), names_from = model_kind, values_from = measure) %>%
  rename(Accelerometer = accel, Outcome = outcome_unit) %>%
  kable(
    caption = glue::glue("LOSO-CV results: Mean RMSE (SD)"), escape = FALSE
  ) %>%
  kable_styling() %>%
  collapse_rows(columns = 1) %>%
  footnote(general_title = "Bold:", general = "Minimal RMSE per Row (Accelerometer and Outcome)")
```


